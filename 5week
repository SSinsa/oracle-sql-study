
ChAPTER 10. 백업/복구의 아키텍처와 동작

# 백업/복구에 필요한 지식의 복습
- 데이터베이스 구성 파일 = 데이터파일, 컨트롤 파일, 리두 로그 파일
- 리두로그 : 데이터베이스의 변경 이력 데이터
- 리두로그 파일을 사용해서 과거의 데이터를 최신 데이터로 만들어 나가는 것을 롤 포워드
- 언두 정보 : 데이터를 과거로 되돌리기 위한 정보
- 롤백은 이 언두 정보를 사용해서 변경한 것을 취소해 나가는 것을 말함
- SCN : 오라클 내부의 시간을 나타내는 숫자
- 체크포인트 : 버퍼 캐시의 데이터와 디스크의 데이터를 동기화하는 것을 말함
- 체크포인트가 끝나면 그때까지 메로리에서 수행되었던 데이터 갱신이 디스크에 바녕되었다는 것을 말함
- 인스턴스 복구는 인스턴스가 비정상 종료될 때나 오라클을 ABORT로 SHUTDOWN해서 다시 기동할 때 자동으로 수행하는 것
- 오라클은 데이터 파일상의 데이터와 리두 로그를 사용해서 데이터를 최신 상태를 만듬
- 이 작업을 통해 커밋한 데이터를 복구할 수 있고, 리두로그를 보면 커밋하지 않은 데이터도 알 수 있으므로 커밋하지 않은 데이터는 차례대로 롤백함

# 백업의 종류와 특징
- 온라인 백업(핫 백업) : 24시간 데이터베이스를 운영하는 상황에서 백업도 받아야 한다는 조건을 충족할 수 있음
- 콜드 백업 : 인스턴트를 완전히 정지한 상태에서 받는 백업
- BEGIN BACKUP과 END BACKUP 사이에 변경이 일어난 블록은 전체 데이터 블록을 리두 로그에 기록하여 나중에 복구 시 문제가 없도록 함

# 데이터베이스 손상의 예
- 디스크의 물리적인 고장으로 인한 데이터 파일의 손상
- 작업 실수 등으로 인한 OS 상에서의 삭제나 덮어쓰기
- 어떤 문제로 인한 블록 손상
- 일시적인 데이터 파일의 접근 불가
- 하드웨어의 물리적인 고장이나 케이블의 문제

# 기본적인 복구의 종류와 동작
- 장애(인스턴스) 복구, 미디어 복구
- 완전 복구, 불완전 복구
- 데이터베이스/테이블 스페이스/데이터 파일/블록의 복구

# 복구할 필요가 없는 테이블 스페이스
- 임시 테이블 스페이스
- 읽기 전용 테이블 스페이스
- 인덱스용 테이블 스페이스

# 기본적인 복구의 흐름
- 데이터베이스가 손상되었는지를 확인한다
- 재작업할 수 있도록 현재 상태를 백업한다
- 필요한 데이터 파일과 아카이브 리두 로그 파일을 리스토어한다
- 복구를 실행한다

# 불완전 복구란?
- 최신 데이터가 아니라 중간까지 하는 복구이므로 일부 데이터가 유실됨
- 리스토어할 데이터 파일은 반드시 복구 목표 시간보다 오래된 것을 사용할 필요가 있음
	-> 아카이브 리두 로그를 사용하여 롤 포워드하기 때문임


Chapter 11. 백그라운드 프로세스의 동작과 역할
# DBWR
- 이미 변경된 데이터를 캐시에서 디스크로 기록하는 역할을 하고 있음
- 커밋한 시점에 기록하는 것은 아님
- LGWR이라고 하는 백그라운드 프로세스가 커밋한 시점의 리두 로그를 디스크에 기록함
- 리두 로그가 디스크에 기록되어 있으면 마에 하나라도 DBWR이 데이터를 디스크에 기록하지 못했더라도 복구할 수 있음
- LGWR은 리도 로그 파일에 리두로그를 기록함
- ARCH라는 백그라운드 프로세스가 아카이브 리두 로그 파일에 기록함

# DBWR 장애 발생
- 대부분 성능이 부족할 때와 I/O의 행이나 지연이 발생했을 때

# LGWR 장애 발생
- 성능이 부족하거나 리두 로그의 생성량이 많을 때, 아카이브를 받는 디스크가 가득 찼을때, 그리고 로그 버퍼가 작을 경우에 장애가 발생

# PMON 
- 백그라운드 프로세스
- 메로리와 프로세스 전문 청소 업체
- 서버 프로세스가 비정상종료했을 때 메모리나 프로세스를 정리
- 필요할 때 세션이나 프로세스를 청소하거나, 내부 락이나 메모리를 가지고 있다면 그것을 해제시킴
- 이 작업을 하지 않으면 서버 프로세스 한 개가 중지되었을 때 인스턴스 전체가 중지될 위험이 있음 -> 약 1분에 한 번 청소 수행
- 중요한 백그라운드 프로세스가 종료했을 때 PMON이 인스턴스를 강제 종료시키는 일이 많음
- 인스턴스 정보, 현재 프로세스 수, 인스턴스 부하를 리스너에 등록하는 작업

# SMON
- 백그라운드 프로세스
- 공간 전문 청소 업체
- 딕셔너리 관리 테이블스ㅔ이스를 사용할 경우 테이블 스페이스 안의 빈 공간들을 합친다든가, 7일 동안 수집된 동시 트랜잭션의 최대 개수에 기반하여 필요 이상의 언두 세그먼트를 오프라인한다든가, 처리 도중에 종료된 트랜잭션을 롤백한다든가, 임시 세그먼트를 청소하거나 함

# ARCH 
- 아카이버 프로세스는 리두 로그 파일을 아카입하는 프로세스

# RECO
- 분산 트랜잭션을 해결하는 프로세스

# CKPT
- 체크포인트를 할 때 DBWR에게 작업 신호를 보냄
- 가장 최근의 체크포인트를 컨트롤 파일과 데이터 파일의 헤더에 기록하는 프로세스

Chapter 12. 오라클 아키텍처와 동작에 관한 큐앤에이

- OS 에서 지연이 발생하면 오라클은?
- > 일반적인 OLTP 시스템에서 OS의 어딘가에서 지연이 발생하면 전체의 처리가 지연됨
- 기본적인 처리의 전반적인 부분들이 느려지므로 마치 동작이 느려진 것과 같은 상태가 되었다 할 수 있음
- OLTP시스템에서는 당연히 대기열이 발생하지만 어디에 대기열이 생길지는 알 수 없음
- 
